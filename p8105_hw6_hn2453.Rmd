---
title: "p8105_hw6_hn2453"
output: github_document
---

```{r}
library(p8105.datasets)
library(dplyr)
library(modelr)
library(tidyr)
library(purrr)
library(ggplot2)
library(tidyverse)
set.seed(1)
```

## problem 1

Import data
```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```
Draw 5000 bootstrap samples and compute lof of product of beta0 and beta1.
```{r}
boot_1 = 
  weather_df |> 
  modelr::bootstrap(n = 5000)

boot_product = boot_1|>
  mutate(
    models = map(strap,\(df)lm(tmax~tmin,data = df)),
    results = map(models, broom::tidy)
  )|>
  select(-strap,-models)|>
  unnest(results)|>
  mutate(
    log_product = ifelse(term=="(Intercept)",NA,log(estimate[term=="(Intercept)"]*estimate))
  )

```

compute the square of r
```{r}
boot_r_square = boot_1|>
  mutate(
    models = map(strap,\(df)lm(tmax~tmin,data = df)),
    results = map(models, broom::glance)
  )|>
  select(-strap,-models)|>
  unnest(results)|>
  mutate( r_square = r.squared)
 
```

Plot the distribution of estimates
```{r}
ggplot(boot_product, aes(x=log_product))+
  geom_density()+
  labs(title = "Distribution of log of product of beta0 and beta1")+
  theme_minimal()
```

```{r}
ggplot(boot_r_square, aes(x=r_square))+
  geom_density()+
  labs(title = "Distribution of r square")+
  theme_minimal()
```

calculate 95% confidence interval
```{r}
CI_r_square = quantile(boot_r_square$r_square,c(0.025,0.975))
CI_r_square
```

```{r}
CI_product = quantile(boot_product$log_product,c(0.025,0.975),na.rm=TRUE)
CI_product
```

## problem 2

import data, clean and arrange these data.
```{r}
homicide = read_csv("data/homicide-data.csv") |>
  janitor::clean_names()|>
  mutate(city_state = paste(city, state, sep = ", "))|>
  mutate(resolved = as.numeric(disposition=="Closed by arrest"))|>
  filter(!city %in% c("Dallas","Phoenix","Kansas City","Tulsa"))|>
  filter(victim_race %in% c("White","Black"))|>
  mutate(victim_age = as.numeric(victim_age))
```
analyze the condition in Baltimore
```{r}
baltimore = homicide |>
  filter(city_state=="Baltimore, MD")
  
  
baltimore_ml = glm(resolved ~ victim_age+victim_sex+victim_race, family = binomial(), data = baltimore)

```

fit a logistic regression and obtain the estimate and confidence interval of odds ratio
```{r}
baltimore_ml |>
  broom:: tidy(conf.int = TRUE)|>
  filter(term=="victim_sexMale")|>
  mutate(OR=exp(estimate),
         exp_conf_low = exp(conf.low),
         exp_conf_high = exp(conf.high))
```
run glm for each of the cities like baltimore
```{r}
citys_ml = homicide|>
  group_by(city_state)|>
  nest()|>
  mutate(
    models = map(data,\(df) glm(resolved ~ victim_age + victim_sex + victim_race, family = binomial,data = df)),
    results = map(models, broom::tidy, conf.int = TRUE)
  )|>
  select(-data,-models)|>
  unnest(results)|>
  filter(term == "victim_sexMale")|>
  mutate(
    OR=exp(estimate),
    exp_conf_low = exp(conf.low),
    exp_conf_high = exp(conf.high)
  )

citys_ml
```
create plot for citys_ml
```{r fig.width = 7, fig.height = 8}
ggplot(citys_ml, aes(x=reorder(city_state, OR), y = OR, ymin = exp_conf_low,ymax=exp_conf_high))+
  geom_pointrange()+
  coord_flip()+
  labs(title = "Adjusted Odds Ratio about Solving Homicides Based on Sex",
       x="City",
       y = "Odds Ratio(CI)")+
  theme_minimal()
  
```
From the plot, we can get that only about 6 cities' odds ratio are larger than 1, and mostly cities' odds ratio are less than 1. Thus, in most cities, male victims are associated with lower odds of the homicide being solved compared to female victims. 


